<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Multi Layer Perceptron</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        canvas {
            max-width: 800px;
            height: 400px;
            margin: 0 auto;
        }
        form {
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            background-color: #f9f9f9;
        }
        form div {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Multi Layer Perceptron training with WASM</h1>
    <div id="output"></div>
    <canvas id="scatterPlot" width="800" height="600"></canvas>
    
    <form id="trainingForm">
        <div>
            <label for="is_classification">Is Classification:</label>
            <input type="checkbox" id="is_classification" name="is_classification" checked>
        </div>
        <div>
            <label for="learning_rate">Learning Rate:</label>
            <input type="number" step="0.01" id="learning_rate" name="learning_rate" value="0.1" required>
        </div>
        <div>
            <label for="nb_iter">Number of Iterations:</label>
            <input type="number" id="nb_iter" name="nb_iter" value="1000" required>
        </div>
        <div>
            <label for="layers">Layers (comma separated):</label>
            <input type="text" id="layers" name="layers" value="2,3,1" required>
        </div>
        <button type="submit">Start Training</button>
    </form>

    <canvas id="lossChart"></canvas>

    <canvas id="scatterPlot_predict" width="800" height="600"></canvas>

    <script type="module">
        import init, { create_mlp, train_mlp, predict_mlp } from './pkg/wasm_ia.js';

        // let X = Array.from({ length: 500 }, () => [
        //     Math.random() * 2 - 1,
        //     Math.random() * 2 - 1
        // ]);


        // Creating Y array based on the condition
        // let Y = X.map(p => [(Math.abs(p[0]) <= 0.3 || Math.abs(p[1]) <= 0.3) ? 1 : -1]);

        let X = [
            [1, 1],
            [2, 3],
            [3, 3]
        ]
        let Y = [
            [1],
            [-1],
            [-1]
        ]

        // let data = {
        //     datasets: [
        //         {
        //             label: 'Class 1',
        //             data: [],
        //             backgroundColor: 'blue'
        //         },
        //         {
        //             label: 'Class -1',
        //             data: [],
        //             backgroundColor: 'red'
        //         }
        //     ]
        // };

        // // Assigning points to the respective datasets based on Y values
        // for (let i = 0; i < X.length; i++) {
        //     if (Y[i][0] === 1) {
        //         data.datasets[0].data.push({ x: X[i][0], y: X[i][1] });
        //     } else {
        //         data.datasets[1].data.push({ x: X[i][0], y: X[i][1] });
        //     }
        // }

        // const ctx_1 = document.getElementById('scatterPlot').getContext('2d');
        // new Chart(ctx_1, {
        //     type: 'scatter',
        //     data: data,
        //     options: {
        //         scales: {
        //             x: {
        //                 type: 'linear',
        //                 position: 'bottom'
        //             },
        //             y: {
        //                 type: 'linear'
        //             }
        //         }
        //     }
        // });


        const ctx = document.getElementById('lossChart').getContext('2d');
        const lossChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Loss',
                    data: [],
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Iteration'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Loss'
                        }
                    }
                }
            }
        });

        window.update_page = (message) => {
            let tmp = message.split('#')
            // console.log(tmp)
            const [iteration, loss] = tmp[0].split(':').map(str => str.trim());
            if (Number(iteration) == 9900) {
                console.log(tmp)
                console.log(tmp[1])
            }
            lossChart.data.labels.push(iteration);
            lossChart.data.datasets[0].data.push(parseFloat(loss));
            lossChart.update();
        };

        let model;

        async function run(is_classification, learning_rate, nb_iter, layers) {
            await init();
            model = create_mlp(layers);

            let step = 100; // Send updates every 10 steps

            console.log(model)

            await train_mlp(model, X, Y, is_classification, 0.01, 10000, step);
            console.log(predict_mlp(model, [1.0, 1.0], 1));
            console.log(predict_mlp(model, [3.0, 3.0], 1));
            // print_prediction();

            console.log(model)
        }


        function print_prediction() {
            const step = 0.02;
            let gridPoints = [];
            for (let x = -1; x <= 1; x += step) {
                for (let y = -1; y <= 1; y += step) {
                    gridPoints.push([x, y]);
                }
            }

            // Predicting the class for each point in the grid
            let backgroundColors = gridPoints.map(p => predict_mlp(model, [p[0], p[1]], 1)[0] > 0 ? '#5787f6' : '#fcaf9e');

            // console.log(predict_mlp(model, [0, 0], 1)[0])
            // console.log(predict_mlp(model, [1, 1], 1)[0])
            // console.log(backgroundColors)

            // Preparing data for Chart.js
            let data_predict = {
                datasets: [
                    {
                        label: 'Class 1',
                        data: [],
                        backgroundColor: 'blue'
                    },
                    {
                        label: 'Class -1',
                        data: [],
                        backgroundColor: 'red'
                    }
                ]
            };

            // Assigning points to the respective datasets based on Y values
            for (let i = 0; i < X.length; i++) {
                if (Y[i][0] === 1) {
                    data_predict.datasets[0].data.push({ x: X[i][0], y: X[i][1] });
                } else {
                    data_predict.datasets[1].data.push({ x: X[i][0], y: X[i][1] });
                }
            }

            // Drawing the background
            const backgroundPlugin = {
                id: 'backgroundPlugin',
                beforeDraw: (chart) => {
                    const ctx = chart.ctx;
                    const chartArea = chart.chartArea;

                    for (let i = 0; i < gridPoints.length; i++) {
                        const [x, y] = gridPoints[i];
                        const color = backgroundColors[i];

                        const pixelX = chart.scales.x.getPixelForValue(x);
                        const pixelY = chart.scales.y.getPixelForValue(y);

                        ctx.fillStyle = color;
                        ctx.fillRect(pixelX - step * chart.width / 2, pixelY - step * chart.height / 2, step * chart.width, step * chart.height);
                    }
                }
            };

            // Creating the scatter plot
            const ctx_predict = document.getElementById('scatterPlot_predict').getContext('2d');
            const chart_predict = new Chart(ctx_predict, {
                type: 'scatter',
                data: data_predict,
                options: {
                    plugins: {
                        filler: {
                            propagate: false
                        }
                    },
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom'
                        },
                        y: {
                            type: 'linear'
                        }
                    },
                    animation: {
                        duration: 0
                    }
                },
                plugins: [backgroundPlugin]
            });
        }

        document.getElementById('trainingForm').addEventListener('submit', (event) => {
            event.preventDefault();
            const is_classification = document.getElementById('is_classification').checked ? 1 : 0;
            const learning_rate = parseFloat(document.getElementById('learning_rate').value);
            const nb_iter = parseInt(document.getElementById('nb_iter').value);
            const layers = document.getElementById('layers').value.split(',').map(Number);
            console.log(is_classification, learning_rate, nb_iter, layers)
            run(is_classification, learning_rate, nb_iter, layers);
        });
    </script>
</body>
</html>
